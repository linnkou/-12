<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>برنامج الهندسة - من إعداد الأستاذ العربي بودهير عبد اللطيف</title>
    <!-- استخدام أيقونات FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <!-- الخطوط الاحترافية -->
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Tajawal:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
    <style>
        /* الإعدادات العامة */
        body {
            font-family: 'Roboto Slab', 'Tajawal', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #e1f5fe, #ffffff);
            color: #333;
            display: flex;
            flex-direction: column;
            /* تغيير إلى flex column لتصميم متجاوب */
            min-height: 100vh;
        }

        /* تعديلات الهيدر */
        .header {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: #fff;
            text-align: center;
            padding: 16px 10px;
            font-size: 20px;
            /* تقليل حجم الخط قليلاً */
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* تقليل الظل */
        }

        .header p {
            font-size: 12px;
            /* تقليل حجم الخط */
            margin-top: 4px;
            color: #e3f2fd;
        }

        /* تعديلات الشريط الجانبي */
        .sidebar {
            width: 100%;
            /* اجعل الشريط الجانبي يشغل العرض الكامل */
            background: #f0f4f8;
            padding: 10px;
            /* تقليل المساحة الداخلية */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* تقليل الظل */
            overflow-x: auto;
            /* إضافة تمرير أفقي إذا لزم الأمر */
            height: auto;
            /* ارتفاع تلقائي */
            transition: all 0.3s ease;
            display: flex;
            flex-wrap: wrap;
            /* السماح للعناصر بالالتفاف */
            justify-content: center;
            /* توسيط العناصر */
        }

        .sidebar h3 {
            font-size: 14px;
            /* تقليل حجم الخط */
            margin: 10px 0 5px;
            /* تقليل الهوامش */
            color: #1565c0;
            border-bottom: 1px solid #cfd8dc;
            padding-bottom: 3px;
            /* تقليل الحشو */
            width: 100%;
            /* عرض كامل */
            text-align: center;
            /* توسيط النص */
        }

        .tool-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            /* عرض العناصر بجانب بعضها البعض */
            flex-wrap: wrap;
            /* السماح للعناصر بالالتفاف */
            justify-content: center;
            /* توسيط العناصر */
        }

        .tool-list li {
            padding: 6px 8px;
            /* تقليل الحشو */
            cursor: pointer;
            transition: background .3s, transform .2s;
            border-radius: 4px;
            font-size: 12px;
            /* تقليل حجم الخط */
            display: flex;
            align-items: center;
            gap: 6px;
            /* تقليل الفجوة */
            margin: 2px;
            /* إضافة هامش صغير */
        }

        .tool-list li:hover {
            background: #e3f2fd;
            transform: scale(1.05);
            /* تكبير طفيف عند التحويم */
            color: #0d47a1;
        }

        .tool-list li i {
            width: 18px;
            /* تقليل العرض */
            text-align: center;
            animation: iconBounce 1.5s infinite;
            font-size: 14px;
            /* تقليل حجم الأيقونة */
        }

        @keyframes iconBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        .tool-category {
            width: 100%;
            /* عرض كامل */
            margin-bottom: 10px;
            /* هامش سفلي */
        }

        /* المحتوى الرئيسي */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            /* تقليل المساحة الداخلية */
        }

        /* لوحة الرسم */
        .canvas-container {
            border: 2px solid #1976d2;
            border-radius: 8px;
            position: relative;
            background: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            width: 100%;
            /* عرض كامل */
            max-width: 800px;
            /* الحد الأقصى للعرض */
            height: auto;
            /* ارتفاع تلقائي */
            margin: 10px auto;
            /* توسيط */
            overflow: hidden;
        }

        canvas {
            display: block;
            margin: auto;
            border-radius: 8px;
            width: 100%;
            /* عرض كامل */
            height: auto;
            /* ارتفاع تلقائي */
        }

        /* شريط الإختصارات تحت لوحة الرسم */
        .tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            /* تقليل الفجوة */
            width: 100%;
            /* عرض كامل */
            max-width: 800px;
            /* الحد الأقصى للعرض */
            margin: 10px auto 0 auto;
            padding: 10px;
            /* تقليل المساحة الداخلية */
            background: #fafafa;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            /* تقليل الظل */
            justify-content: center;
        }

        .tool-btn {
            background: #e3f2fd;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            /* تقليل الحشو */
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            /* تقليل الفجوة */
            font-size: 12px;
            /* تقليل حجم الخط */
            color: #1565c0;
            transition: background 0.3s, transform 0.2s;
        }

        .tool-btn:hover {
            background: #bbdefb;
            transform: scale(1.05);
            /* تكبير طفيف عند التحويم */
        }

        .tool-btn.active {
            background: #1565c0;
            color: #fff;
        }

        .tool-btn i {
            font-size: 16px;
            /* تقليل حجم الأيقونة */
        }

        /* النوافذ المنبثقة */
        .modal {
            display: none;
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background: #fff;
            margin: 15% auto;
            /* تعديل الهامش العلوي */
            padding: 15px;
            /* تقليل المساحة الداخلية */
            border: 1px solid #ddd;
            width: 80%;
            /* اجعل النافذة المنبثقة تشغل 80% من العرض */
            max-width: 400px;
            /* حد أقصى للعرض */
            border-radius: 8px;
        }

        .modal-content h4 {
            margin-top: 0;
            text-align: center;
            color: #1565c0;
            font-size: 16px;
            /* تقليل حجم الخط */
        }

        .modal-content label {
            display: block;
            margin-top: 8px;
            /* تقليل الهامش العلوي */
            font-size: 12px;
            /* تقليل حجم الخط */
        }

        .modal-content input[type="color"],
        .modal-content input[type="number"],
        .modal-content input[type="text"],
        .modal-content select {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            /* تقليل الهامش العلوي */
            border: 1px solid #cfd8dc;
            border-radius: 4px;
            font-size: 12px;
            /* تقليل حجم الخط */
        }

        .modal-buttons {
            margin-top: 15px;
            /* تقليل الهامش العلوي */
            text-align: center;
        }

        .modal-buttons button {
            padding: 6px 12px;
            /* تقليل الحشو */
            margin: 0 4px;
            /* تقليل الهوامش */
            border: none;
            background: #1565c0;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 12px;
            /* تقليل حجم الخط */
        }

        .modal-buttons button:hover {
            background: #0d47a1;
        }

        /* نافذة تعديل خصائص الرسم */
        #propertyModal {
            width: 90%;
            /* اجعلها متجاوبة */
            max-width: 300px;
            /* حد أقصى للعرض */
            position: absolute;
            z-index: 1200;
        }

        /* التصميم المتجاوب */
        @media (min-width: 768px) {
            body {
                flex-direction: row;
                /* العودة إلى تخطيط الصف */
            }

            .sidebar {
                width: 200px;
                /* عرض الشريط الجانبي */
                height: 100vh;
                /* ملء الارتفاع */
                display: block;
                /* عرضه ككتلة */
                flex-wrap: nowrap;
                /* منع الالتفاف */
                justify-content: flex-start;
                /* محاذاة إلى البداية */
                overflow-x: hidden;
                /* إخفاء التمرير الأفقي */
            }

            .tool-list {
                flex-direction: column;
                /* عرض العناصر عمودياً */
                align-items: stretch;
                /* تمديد العناصر */
            }

            .tool-list li {
                margin: 0;
                /* إزالة الهوامش */
                text-align: center;
                /* توسيط النص */
            }

            .tool-category h3 {
                text-align: right;
                /* محاذاة النص إلى اليمين */
            }
        }
    </style>
</head>

<body>
    <!-- الشريط الجانبي -->
    <div class="sidebar">
        <div class="tool-category">
            <h3>أدوات أساسية</h3>
            <ul class="tool-list">
                <li onclick="activateTool('move')"><i class="fas fa-hand-paper"></i>تحريك الورقة</li>
                <li onclick="activateTool('select')"><i class="fas fa-mouse-pointer"></i>تحديد عنصر</li>
                <li onclick="pointToolClicked()"><i class="fas fa-dot-circle"></i>نقطة</li>
                <li onclick="activateTool('link')"><i class="fas fa-link"></i>ربط نقاط</li>
                <li onclick="activateTool('phrases')"><i class="fas fa-pencil-alt"></i>كتابة جمل/حروف</li>
                <li onclick="activateTool('angle')"><i class="fas fa-ruler-combined"></i>زاوية</li>
                <li onclick="activateTool('delete')"><i class="fas fa-trash"></i>مسح</li>
            </ul>
        </div>
        <!-- قسم المستقيمات -->
        <div class="tool-category">
            <h3>المستقيمات</h3>
            <ul class="tool-list">
                <li onclick="openLineModal('line')"><i class="fas fa-ruler"></i>مستقيم</li>
                <li onclick="openLineModal('segment')"><i class="fas fa-ruler-horizontal"></i>قطعة مستقيمة</li>
                <li onclick="activateTool('ray')"><i class="fas fa-long-arrow-alt-right"></i>شعاع</li>
            </ul>
        </div>
        <div class="tool-category">
            <h3>أشكال ومضلعات</h3>
            <ul class="tool-list">
                <li onclick="openShapeModal('rectangle')"><i class="fas fa-border-style"></i>مستطيل</li>
                <li onclick="openShapeModal('square')"><i class="fas fa-th-large"></i>مربع</li>
                <li onclick="openShapeModal('triangle')"><i class="fas fa-play"></i>مثلث</li>
                <li onclick="openShapeModal('rhombus')"><i class="fas fa-diamond"></i>معين</li>
                <li onclick="activateTool('polyFree')"><i class="fas fa-draw-polygon"></i>مضلع كيفي</li>
                <li onclick="openPolyRegularModal()"><i class="fas fa-shapes"></i>مضلع منتظم</li>
                <li onclick="openCircleModal()"><i class="fas fa-circle"></i>دائرة</li>
            </ul>
        </div>
        <div class="tool-category">
            <h3>أدوات إضافية</h3>
            <ul class="tool-list">
                <li onclick="toggleTeacher()"><i class="fas fa-chalkboard"></i>المعلم</li>
                <li onclick="toggleGrid()"><i class="fas fa-th"></i>التقسيمات</li>
                <li onclick="toggleTeacherNumbers()"><i class="fas fa-sort-numeric-up"></i>أرقام المعلم</li>
                <li onclick="undoAction()"><i class="fas fa-undo"></i>تراجع</li>
                <li onclick="redoAction()"><i class="fas fa-redo"></i>إعادة</li>
                <li onclick="activateTool('save')"><i class="fas fa-save"></i>حفظ</li>
            </ul>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="main-content">
        <div class="header">
            برنامج الهندسة
            <p>من إعداد الأستاذ العربي بودهير عبد اللطيف</p>
        </div>
        <!-- لوحة الرسم -->
        <div class="canvas-container">
            <canvas id="drawingCanvas" width="800" height="600"></canvas>
        </div>
        <!-- شريط الإختصارات أسفل لوحة الرسم -->
        <div class="tools">
            <div class="tool-btn" id="pointTool" onclick="pointToolClicked()">
                <i class="fas fa-dot-circle"></i>
                <span>نقطة</span>
            </div>
            <div class="tool-btn" id="lineTool" onclick="openLineModal('line')">
                <i class="fas fa-ruler"></i>
                <span>مستقيم</span>
            </div>
            <div class="tool-btn" id="circleTool" onclick="activateTool('circle')">
                <i class="far fa-circle"></i>
                <span>دائرة</span>
            </div>
            <div class="tool-btn" id="penTool" onclick="activateTool('pen')">
                <i class="fas fa-pen"></i>
                <span>قلم حر</span>
            </div>
            <div class="tool-btn" id="moveTool" onclick="activateTool('move')">
                <i class="fas fa-hand-paper"></i>
                <span>تحريك الورقة</span>
            </div>
            <div class="tool-btn" id="selectTool" onclick="activateTool('select')">
                <i class="fas fa-mouse-pointer"></i>
                <span>تحديد عنصر</span>
            </div>
            <div class="tool-btn" id="uploadImageBtn"
                onclick="document.getElementById('uploadInput').click()">
                <i class="fas fa-upload"></i>
                <span>رفع صورة</span>
            </div>
            <div class="tool-btn" id="copyDrawingBtn" onclick="copySelectedObjects()">
                <i class="fas fa-clone"></i>
                <span>نسخ الرسومات</span>
            </div>
        </div>
    </div>

    <!-- عنصر رفع الصورة المخفي -->
    <input type="file" id="uploadInput" style="display:none" accept="image/*" onchange="handleImageUpload(event)" />

    <!-- النوافذ المنبثقة -->
    <div id="shapeModal" class="modal">
        <div class="modal-content">
            <h4 id="shapeModalTitle">إعدادات الشكل</h4>
            <div id="dimensionFields"></div>
            <label for="strokeColorShapeInput">لون الحدود:</label>
            <input type="color" id="strokeColorShapeInput" value="#ff5722" />
            <label for="fillColorShapeInput">لون التعبئة:</label>
            <input type="color" id="fillColorShapeInput" value="#ffffff" />
            <div class="modal-buttons">
                <button onclick="confirmShapeModal()">تأكيد</button>
                <button onclick="closeShapeModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="lineModal" class="modal">
        <div class="modal-content">
            <h4 id="lineModalTitle">إعدادات الخط</h4>
            <label for="lineStyleSelect">نمط الخط:</label>
            <select id="lineStyleSelect">
                <option value="solid">غير متقطعة</option>
                <option value="dashed">متقطعة</option>
            </select>
            <label for="lineLengthInput">الطول (للقطعة - بالسنتيمتر):</label>
            <input type="number" id="lineLengthInput" value="10" min="1" />
            <label for="lineColorInput">لون الخط:</label>
            <input type="color" id="lineColorInput" value="#007bff" />
            <label for="lineThicknessInput">سماكة الخط:</label>
            <input type="number" id="lineThicknessInput" value="2" min="1" />
            <div class="modal-buttons">
                <button onclick="confirmLineModal()">تأكيد</button>
                <button onclick="closeLineModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="textEditModal" class="modal">
        <div class="modal-content">
            <h4>إعدادات النص</h4>
            <label for="userTextInput">النص:</label>
            <input type="text" id="userTextInput" placeholder="اكتب هنا" />
            <label for="fontFamilySelect">نوع الخط:</label>
            <select id="fontFamilySelect">
                <option value="Tajawal">Tajawal</option>
                <option value="Arial">Arial</option>
                <option value="Tahoma">Tahoma</option>
            </select>
            <label for="fontSizeInput">حجم الخط:</label>
            <input type="number" id="fontSizeInput" value="20" min="10" />
            <label for="textColorInput">لون النص:</label>
            <input type="color" id="textColorInput" value="#333333" />
            <div class="modal-buttons">
                <button onclick="confirmTextEditModal()">تأكيد</button>
                <button onclick="closeTextEditModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="angleModal" class="modal">
        <div class="modal-content">
            <h4>إعدادات قياس الزاوية</h4>
            <label for="showAngleCheckbox">
                <input type="checkbox" id="showAngleCheckbox" checked /> إظهار القياس
            </label>
            <label for="angleDirectionSelect">اتجاه التشفير:</label>
            <select id="angleDirectionSelect">
                <option value="normal">طبيعي</option>
                <option value="reversed">مقلوب</option>
            </select>
            <label for="desiredAngleInput">قيمة الزاوية (بالدرجات):</label>
            <input type="number" id="desiredAngleInput" value="45" min="1" max="179" />
            <div class="modal-buttons">
                <button onclick="confirmAngleModal()">تأكيد</button>
                <button onclick="closeAngleModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="polyModal" class="modal">
        <div class="modal-content">
            <h4>إعدادات المضلع المنتظم</h4>
            <label for="sidesInput">عدد الأضلاع:</label>
            <input type="number" id="sidesInput" value="5" min="3" />
            <label for="radiusInput">القطر المطلوب (بـ cm):</label>
            <input type="number" id="radiusInput" value="50" min="10" />
            <label for="strokeColorPolyInput">لون الحدود:</label>
            <input type="color" id="strokeColorPolyInput" value="#ff00ff" />
            <div class="modal-buttons">
                <button onclick="confirmPolyModal()">تأكيد</button>
                <button onclick="closePolyModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="pointModal" class="modal">
        <div class="modal-content">
            <h4>إعدادات النقطة</h4>
            <label for="pointTypeSelect">نوع النقطة:</label>
            <select id="pointTypeSelect">
                <option value="circle">دائري</option>
                <option value="x">X</option>
            </select>
            <label for="pointSizeInput">الحجم (بـ cm):</label>
            <input type="number" id="pointSizeInput" value="0.3" min="0.1" step="0.1" />
            <label for="pointColorInput">لون النقطة:</label>
            <input type="color" id="pointColorInput" value="#007bff" />
            <div class="modal-buttons">
                <button onclick="confirmPointModal()">تأكيد</button>
                <button onclick="closePointModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="saveModal" class="modal">
        <div class="modal-content">
            <h4>إعدادات الحفظ</h4>
            <label for="saveWidthInput">عرض الورقة (بـ cm):</label>
            <input type="number" id="saveWidthInput" value="21" min="5" />
            <label for="saveHeightInput">ارتفاع الورقة (بـ cm):</label>
            <input type="number" id="saveHeightInput" value="29.7" min="5" />
            <div class="modal-buttons">
                <button onclick="confirmSaveModal()">حفظ</button>
                <button onclick="closeSaveModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="circleShapeModal" class="modal">
        <div class="modal-content">
            <h4>إعدادات الدائرة</h4>
            <label for="circleRadiusInput">نصف القطر (بـ cm):</label>
            <input type="number" id="circleRadiusInput" value="5" min="1" />
            <label for="strokeColorCircleInput">لون الحدود:</label>
            <input type="color" id="strokeColorCircleInput" value="#007bff" />
            <label for="fillColorCircleInput">لون التعبئة:</label>
            <input type="color" id="fillColorCircleInput" value="#ffffff" />
            <label for="circleFillTypeSelect">نوع التعبئة:</label>
            <select id="circleFillTypeSelect">
                <option value="filled">ممتلئة</option>
                <option value="empty">فارغة</option>
            </select>
            <label for="circleShapeSelect">شكل الدائرة:</label>
            <select id="circleShapeSelect">
                <option value="normal">عادية</option>
                <option value="half">نصف دائرة</option>
                <option value="quarter">ربع دائرة</option>
            </select>
            <div class="modal-buttons">
                <button onclick="confirmCircleModal()">تأكيد</button>
                <button onclick="closeCircleModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <h4>تعديل الخصائص</h4>
            <label for="propStrokeColorInput">لون الحدود:</label>
            <input type="color" id="propStrokeColorInput" value="#000000" />
            <label for="propStrokeWidthInput">سماكة الحدود:</label>
            <input type="number" id="propStrokeWidthInput" value="2" min="1" />
            <div id="fillColorContainer" style="display: none;">
                <label for="propFillColorInput">لون التعبئة:</label>
                <input type="color" id="propFillColorInput" value="#ffffff" />
            </div>
            <div class="modal-buttons">
                <button onclick="updateObjectProperties()">تحديث</button>
                <button onclick="closePropertyModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        /**************** إعدادات Undo/Redo ****************/
        let undoStack = [];
        let redoStack = [];
        let restoreInProgress = false;
        const CM_IN_PX = 37.8; // بكسل لكل سنتيمتر

        let gridGroup = null;
        let polyFreePoints = [];

        // إعدادات النقطة بعد تأكيدها
        let pointSettings = null;

        // إنشاء الكانفاس
        const canvas = new fabric.Canvas("drawingCanvas", {
            renderOnAddRemove: true,
            selection: true,
        });
        let activeTool = null;

        /* --- دوال Undo/Redo --- */
        function saveState() {
            if (!restoreInProgress) {
                undoStack.push(JSON.stringify(canvas));
                redoStack = [];
            }
        }
        function undoAction() {
            if (undoStack.length > 1) {
                restoreInProgress = true;
                redoStack.push(JSON.stringify(canvas));
                undoStack.pop();
                canvas.loadFromJSON(undoStack[undoStack.length - 1], function () {
                    canvas.renderAll();
                    restoreInProgress = false;
                });
            }
        }
        function redoAction() {
            if (redoStack.length > 0) {
                restoreInProgress = true;
                undoStack.push(JSON.stringify(canvas));
                const redoState = redoStack.pop();
                canvas.loadFromJSON(redoState, function () {
                    canvas.renderAll();
                    restoreInProgress = false;
                });
            }
        }
        /* --- أدوات الكانفاس --- */
        // دالة تفعيل الأداة
        function activateTool(toolName) {
            activeTool = toolName;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(toolName + 'Tool').classList.add('active');
            canvas.isDrawingMode = false; // تعطيل وضع الرسم الحر افتراضياً
            canvas.selection = true; // تفعيل التحديد افتراضياً
            canvas.defaultCursor = 'default';
            canvas.discardActiveObject().renderAll();

            if (toolName === 'pen') {
                canvas.isDrawingMode = true;
                canvas.freeDrawingBrush.color = 'red';
                canvas.freeDrawingBrush.width = 3;
            } else if (toolName === 'move') {
                canvas.defaultCursor = 'grab';
                canvas.selection = false;
            } else if (toolName === 'select') {
                canvas.selection = true;
            }
        }
        /* --- وظائف التعامل مع العناصر --- */
        // وظيفة نسخ العناصر المحددة
        function copySelectedObjects() {
            if (canvas.getActiveObject()) {
                canvas.getActiveObject().clone(function (cloned) {
                    _clipboard = cloned;
                });
            }
        }
        // وظيفة اللصق
        var _clipboard;
        canvas.on('paste', function (e) {
            if (_clipboard) {
                _clipboard.clone(function (clonedObj) {
                    canvas.discardActiveObject();
                    clonedObj.set({
                        left: clonedObj.left + 10,
                        top: clonedObj.top + 10,
                        evented: true,
                    });
                    if (clonedObj.type === 'active_selection') {
                        // active selection needs a reference to the canvas.
                        clonedObj.canvas = canvas;
                        clonedObj.forEachObject(function (obj) {
                            canvas.add(obj);
                        });
                        // this should solve the "corner is not an object" error.
                        clonedObj.setCoords();
                    } else {
                        canvas.add(clonedObj);
                    }
                    _clipboard.top += 10;
                    _clipboard.left += 10;
                    canvas.setActiveObject(clonedObj);
                    canvas.requestRenderAll();
                });
            }
        });
        // وظيفة حذف العناصر
        canvas.on('object:removed', function (options) {
            saveState();
        });
        canvas.on('object:added', function (options) {
            saveState();
        });
        canvas.on('object:modified', function (options) {
            saveState();
        });
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && (e.key === 'c' || e.charCode === 99)) {
                copySelectedObjects();
            }
            if (e.ctrlKey && (e.key === 'v' || e.charCode === 118)) {
                canvas.fire('paste');
            }
            if (event.key === 'Delete') {
                deleteObject();
            }
            if (event.ctrlKey && event.key === 'z') {
                undoAction();
            }
            if (event.ctrlKey && event.key === 'y') {
                redoAction();
            }
        });
        function deleteObject() {
            var activeObject = canvas.getActiveObject(),
                activeGroup = canvas.getActiveGroup();
            if (activeObject) {
                canvas.remove(activeObject);
            } else if (activeGroup) {
                var objectsInGroup = activeGroup.getObjects();
                canvas.discardActiveGroup();
                objectsInGroup.forEach(function (object) {
                    canvas.remove(object);
                });
            }
        }
        /* --- وظائف النوافذ المنبثقة --- */
        // دالة فتح النافذة المنبثقة
        function openModal(modalId) {
            document.getElementById(modalId).style.display = "block";
        }
        // دالة إغلاق النافذة المنبثقة
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }
        /**************** أدوات الرسم ****************/
        /* --- وظائف التعامل مع النقاط --- */
        // عند النقر على أداة النقطة
        function pointToolClicked() {
            activateTool('point');
            openModal('pointModal');
        }
        function confirmPointModal() {
            pointSettings = {
                type: document.getElementById('pointTypeSelect').value,
                size: parseFloat(document.getElementById('pointSizeInput').value),
                color: document.getElementById('pointColorInput').value
            };
            closeModal('pointModal');
            canvas.on('mouse:down', addPoint);
        }
        function closePointModal() {
            closeModal('pointModal');
            canvas.off('mouse:down', addPoint);
        }
        // دالة إضافة نقطة
        function addPoint(options) {
            if (activeTool === 'point' && pointSettings) {
                let point;
                let pointer = canvas.getPointer(options.e);
                let sizeInPixels = pointSettings.size * CM_IN_PX;
                if (pointSettings.type === 'circle') {
                    point = new fabric.Circle({
